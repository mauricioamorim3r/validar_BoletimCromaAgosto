{% extends "base.html" %}

{% block title %}Importar Excel{% endblock %}

{% block content %}
<style>
    /* Aplicando a fonte Inter e melhorias visuais */
    .card, .btn, .alert, .form-control, .form-label, h4, h5, p, li, td, th {
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
    }
    
    .card-header.primary-header {
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        color: white;
        border-radius: 8px 8px 0 0;
        padding: 15px 20px;
        font-weight: 600;
    }
    
    .card {
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
        font-weight: 600;
        border-radius: 8px 8px 0 0;
    }
    
    .btn {
        border-radius: 6px;
        font-weight: 500;
        padding: 10px 20px;
        transition: all 0.2s ease;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        border: none;
    }
    
    .btn-success {
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
    }
    
    .btn-warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        border: none;
    }
    
    .alert {
        border-radius: 8px;
        border: none;
        font-weight: 500;
    }
    
    .form-control {
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        transition: all 0.2s ease;
    }
    
    .form-control:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .text-muted {
        color: #64748b !important;
    }
</style>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header primary-header">
                    <h4 class="mb-0">
                        <i class="fas fa-file-excel"></i> 
                        Importar Dados via Excel
                    </h4>
                </div>
                <div class="card-body">
                    
                    <!-- Alertas -->
                    {% with messages = get_flashed_messages() %}
                        {% if messages %}
                            {% for message in messages %}
                                {% if 'error' in message or '‚ùå' in message %}
                                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% elif '‚úÖ' in message or 'sucesso' in message %}
                                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% elif 'üìã' in message %}
                                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <div class="row">
                        <!-- Op√ß√£o 1: Processar Boletins Existentes -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header" style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white;">
                                    <h5 class="mb-0">
                                        <i class="fas fa-cogs"></i> 
                                        Processar Boletins Existentes
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">
                                        <strong>Detectamos que voc√™ tem boletins j√° cadastrados</strong> que n√£o aparecem na aba "Hist√≥rico".
                                    </p>
                                    <p>
                                        Isso acontece porque eles foram inseridos diretamente no banco de dados, sem passar pelo processo completo de valida√ß√£o.
                                    </p>
                                    <p class="text-muted">
                                        <small>
                                            <i class="fas fa-info-circle"></i>
                                            Esta op√ß√£o vai criar os componentes faltantes e permitir a revalida√ß√£o.
                                        </small>
                                    </p>
                                    
                                    <div class="d-grid">
                                        <a href="{{ url_for('processar_boletins_existentes') }}" 
                                           class="btn btn-lg"
                                           style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none;"
                                           onclick="return confirm('Isso ir√° processar todos os boletins existentes. Confirma?')">
                                            <i class="fas fa-play"></i> 
                                            Processar Boletins Existentes
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Op√ß√£o 2: Importar Novos Dados -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header" style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white;">
                                    <h5 class="mb-0">
                                        <i class="fas fa-upload"></i> 
                                        Importar Novos Dados
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">
                                        <strong>Importe dados de boletins</strong> a partir de um arquivo Excel estruturado.
                                    </p>
                                    
                                    <!-- Download Template -->
                                    <div class="mb-3">
                                        <a href="{{ url_for('download_template') }}" 
                                           class="btn btn-sm"
                                           style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none;">
                                            <i class="fas fa-download"></i> 
                                            Baixar Template Excel
                                        </a>
                                        <small class="text-muted d-block mt-1">
                                            Use este template para organizar seus dados
                                        </small>
                                    </div>

                                    <!-- Upload Form -->
                                    <form action="{{ url_for('upload_excel') }}" 
                                          method="post" 
                                          enctype="multipart/form-data"
                                          class="mb-3">
                                        
                                        <div class="mb-3">
                                            <label for="arquivo" class="form-label">
                                                <strong>Selecione o arquivo Excel:</strong>
                                            </label>
                                            <input type="file" 
                                                   class="form-control" 
                                                   id="arquivo" 
                                                   name="arquivo"
                                                   accept=".xlsx,.xls,.csv"
                                                   required>
                                            <div class="form-text">
                                                Formatos aceitos: .xlsx, .xls, .csv (m√°x. 16MB)
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-lg"
                                                    style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none;">
                                                <i class="fas fa-cloud-upload-alt"></i> 
                                                Importar Arquivo
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Instru√ß√µes -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header" style="background: linear-gradient(135deg, #6c757d, #495057); color: white;">
                                    <h5 class="mb-0">
                                        <i class="fas fa-question-circle"></i> 
                                        Como funciona a importa√ß√£o?
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>üìã <strong>Estrutura do Excel:</strong></h6>
                                            <ul class="list-unstyled">
                                                <li>‚Ä¢ <strong>Aba "Boletins":</strong> Dados b√°sicos (n√∫mero, datas, respons√°veis)</li>
                                                <li>‚Ä¢ <strong>Aba "Componentes":</strong> Percentuais molares dos 15 componentes</li>
                                                <li>‚Ä¢ <strong>Aba "Instru√ß√µes":</strong> Guia completo de preenchimento</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>‚öôÔ∏è <strong>Processamento Autom√°tico:</strong></h6>
                                            <ul class="list-unstyled">
                                                <li>‚Ä¢ Valida√ß√£o A.G.A #8 (limites normativos)</li>
                                                <li>‚Ä¢ Valida√ß√£o CEP (controle estat√≠stico)</li>
                                                <li>‚Ä¢ Cria√ß√£o do hist√≥rico de componentes</li>
                                                <li>‚Ä¢ Defini√ß√£o do status final (VALIDADO/INVALIDADO)</li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info mt-3">
                                        <i class="fas fa-lightbulb"></i>
                                        <strong>Dica:</strong> 
                                        Se voc√™ j√° tem boletins no sistema, comece processando os existentes. 
                                        Depois use a importa√ß√£o Excel para adicionar novos dados em lote.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√µes de Navega√ß√£o -->
                    <div class="row mt-4">
                        <div class="col-12 text-center">
                            <a href="{{ url_for('listar_boletins') }}" class="btn me-2"
                               style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none;">
                                <i class="fas fa-list"></i> 
                                Voltar aos Boletins
                            </a>
                            <a href="{{ url_for('dashboard') }}" class="btn"
                               style="background: linear-gradient(135deg, #95a5a6, #7f8c8d); color: white; border: none;">
                                <i class="fas fa-tachometer-alt"></i> 
                                Dashboard
                            </a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script para preview do arquivo selecionado -->
<script>
document.getElementById('arquivo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
        const fileName = file.name;
        
        // Criar preview
        const preview = document.createElement('div');
        preview.className = 'alert alert-info mt-2';
        preview.innerHTML = `
            <i class="fas fa-file-excel"></i> 
            <strong>Arquivo selecionado:</strong> ${fileName} (${fileSize} MB)
        `;
        
        // Remover preview anterior se existir
        const existingPreview = document.querySelector('.file-preview');
        if (existingPreview) {
            existingPreview.remove();
        }
        
        preview.classList.add('file-preview');
        e.target.parentNode.appendChild(preview);
    }
});
</script>
{% endblock %}
