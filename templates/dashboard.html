{% extends "base.html" %}

{% block content %}
<div class="excel-container">
    <!-- Cabe√ßalho SGM - Dashboard -->
    <div class="brava-header">
        <div class="brava-logo">SGM</div>
        <h1>DASHBOARD - AN√ÅLISES CROMATOGR√ÅFICAS</h1>
        <div class="subtitle">Instala√ß√µes de Produ√ß√£o Offshore - Ger√™ncia de Acompanhamento da Produ√ß√£o</div>
    </div>

    <!-- Filtros Avan√ßados -->
    <div class="filters-container" style="background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div class="section-header">FILTROS AVAN√áADOS</div>
        <form method="GET" id="filterForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
            <div>
                <label for="periodo" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Per√≠odo:</label>
                <select name="periodo" id="periodo" class="form-control" style="border-radius: 4px;">
                    <option value="">Todos os per√≠odos</option>
                    <option value="7">√öltimos 7 dias</option>
                    <option value="30">√öltimos 30 dias</option>
                    <option value="90">√öltimos 90 dias</option>
                    <option value="365">√öltimo ano</option>
                </select>
            </div>
            <div>
                <label for="status_filter" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Status:</label>
                <select name="status_filter" id="status_filter" class="form-control" style="border-radius: 4px;">
                    <option value="">Todos os status</option>
                    <option value="VALIDADO">Validados</option>
                    <option value="INVALIDADO">Invalidados</option>
                    <option value="PENDENTE">Pendentes</option>
                </select>
            </div>
            <div>
                <label for="componente_filter" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Componente:</label>
                <select name="componente_filter" id="componente_filter" class="form-control" style="border-radius: 4px;">
                    <option value="">Todos os componentes</option>
                    <option value="Metano">Metano</option>
                    <option value="Etano">Etano</option>
                    <option value="Propano">Propano</option>
                    <option value="i-Butano">i-Butano</option>
                    <option value="n-Butano">n-Butano</option>
                    <option value="i-Pentano">i-Pentano</option>
                    <option value="n-Pentano">n-Pentano</option>
                    <option value="Hexano">Hexano</option>
                    <option value="Heptano">Heptano</option>
                    <option value="Octano">Octano</option>
                    <option value="Nonano">Nonano</option>
                    <option value="Decano">Decano</option>
                    <option value="Oxig√™nio">Oxig√™nio</option>
                    <option value="Nitrog√™nio">Nitrog√™nio</option>
                    <option value="CO2">CO2</option>
                </select>
            </div>
            <div style="display: flex; flex-direction: row;">
                <button type="submit" class="btn btn-primary" style="height: 38px; display: flex; align-items: center; justify-content: center;">
                    üîç Filtrar
                </button>
                <button type="button" class="btn btn-secondary" style="height: 38px; margin-left: 10px; display: flex; align-items: center; justify-content: center;" onclick="clearFilters()">
                    üîÑ Limpar
                </button>
            </div>
        </form>
    </div>

    <!-- Cards de Estat√≠sticas -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0;">
        <!-- Card Total Boletins -->
        <div style="background: linear-gradient(135deg, #204bd6de, #204bd6de); color: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 10px 0; font-size: 2.5rem;">{{ stats.total | number_format(0) }}</h3>
            <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Total de Boletins</p>
        </div>

        <!-- Card Taxa Valida√ß√£o -->
        <div style="background: linear-gradient(135deg, #10b981, #34d399); color: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 10px 0; font-size: 2.5rem;">{{ stats.aprovados | number_format(0) }}</h3>
            <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Aprovados</p>
        </div>

        <!-- Card Pendentes -->
        <div style="background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 10px 0; font-size: 2.5rem;">{{ stats.pendentes | number_format(0) }}</h3>
            <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Pendentes</p>
        </div>

        <!-- Card Rejeitados -->
        <div style="background: linear-gradient(135deg, #ef4444, #f87171); color: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 10px 0; font-size: 2.5rem;">{{ stats.rejeitados | number_format(0) }}</h3>
            <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Rejeitados</p>
        </div>
    </div>

    <!-- Se√ß√£o: Componentes com Mais Problemas -->
    <div class="section-header">COMPONENTES COM MAIOR TAXA DE ERRO CEP</div>
    <div style="background: white; margin-bottom: 20px;font-size: 0.8rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <table class="componentes-excel">
            <thead>
                <tr>
                    <th>Componente</th>
                    <th>Total An√°lises</th>
                    <th>Invalidados CEP</th>
                    <th>Taxa de Erro</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for comp in componentes_problemas %}
                <tr>
                    <td class="component-name">{{ comp.nome }}</td>
                    <td class="numeric">{{ comp.total | number_format(0) }}</td>
                    <td class="numeric">{{ comp.invalidados | number_format(0) }}</td>
                    <td class="numeric">{{ comp.taxa_erro | number_format(2) }}%</td>
                    <td class="text-center">
                        <span class="status-{% if comp.taxa_erro < 20 %}validado{% else %}invalidado{% endif %}">
                            {% if comp.taxa_erro < 20 %}CONTROLADO{% else %}ATEN√á√ÉO{% endif %}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Se√ß√£o: √öltimos Boletins -->
    <div class="section-header">√öLTIMOS BOLETINS PROCESSADOS</div>
    <div style="background: white; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <table class="componentes-excel">
            <thead>
                <tr>
                    <th>Boletim</th>
                    <th>Instala√ß√£o</th>
                    <th>Data Coleta</th>
                    <th>Status Geral</th>
                    <th>A.G.A #8</th>
                    <th>CEP</th>
                    <th>Checklist</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for boletim in boletins_recentes %}
                <tr>
                    <td class="component-name">{{ boletim.numero_boletim }}</td>
                    <td>{{ boletim.identificacao_instalacao }}</td>
                    <td class="numeric">{{ boletim.data_coleta | date_format }}</td>
                    <td class="text-center">
                        <span class="status-{{ 'validado' if boletim.status == 'VALIDADO' else 'invalidado' }}">
                            {{ boletim.status or 'PENDENTE' }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="status-{{ 'validado' if boletim.status_aga8 == 'VALIDADO' else 'invalidado' }}">
                            {{ boletim.status_aga8 or '-' }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="status-{{ 'validado' if boletim.status_cep == 'VALIDADO' else 'invalidado' }}">
                            {{ boletim.status_cep or '-' }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="status-{{ 'validado' if boletim.status_checklist == 'VALIDADO' else 'invalidado' }}">
                            {{ boletim.status_checklist or '-' }}
                        </span>
                    </td>
                    <td class="text-center">
                        <a href="{{ url_for('relatorio', boletim_id=boletim.id) }}" 
                           style="background: #0a2472; color: white; padding: 5px 10px; text-decoration: none; border-radius: 4px; font-size: 0.85rem; font-weight: 600; margin-right: 4px;">
                            Ver Relat√≥rio
                        </a>
                        <a href="{{ url_for('relatorio_pdf', boletim_id=boletim.id) }}" 
                           style="background: #065535; color: white; padding: 5px 10px; text-decoration: none; border-radius: 4px; font-size: 0.85rem; font-weight: 600;"
                           target="_blank">
                            PDF
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Se√ß√£o: Gr√°fico de Tend√™ncias CEP -->
    <div class="section-header">GR√ÅFICO DE TEND√äNCIAS - COMPONENTES PRINCIPAIS</div>
    <div style="background: white; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <canvas id="cepTrendsChart" width="800" height="300" style="max-width: 100%;"></canvas>
        <p style="text-align: center; color: #666; font-size: 0.85rem; margin-top: 10px;">
            * Gr√°fico mostra as √∫ltimas an√°lises dos 5 componentes principais
        </p>
    </div>

    <!-- Resumo de Performance -->
    <div class="resultado-header">RESUMO DE PERFORMANCE DO SISTEMA</div>
    <div class="resultado-final">
        <div class="resultado-item" style="background: linear-gradient(135deg, #10b981, #34d399);">
            A.G.A #8<br>{{ stats.aprovados }}/{{ stats.total }}
        </div>
        <div class="resultado-item" style="background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white;">
            CEP<br>{{ stats.aprovados }}/{{ stats.total }}
        </div>
        <div class="resultado-item" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">
            CHECKLIST<br>{{ stats.aprovados }}/{{ stats.total }}
        </div>
    </div>
</div>

<!-- Script para Gr√°fico de Tend√™ncias -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('cepTrendsChart').getContext('2d');
    
    // Dados do hist√≥rico passados do template
    const historicoData = {{ historico_grafico | tojson }};
    
    // Processar dados por componente
    const componentesData = {};
    const labels = [];
    
    historicoData.forEach(item => {
        if (!componentesData[item.componente]) {
            componentesData[item.componente] = [];
        }
        componentesData[item.componente].push({
            x: item.data_coleta,
            y: item.valor,
            status: item.status_cep
        });
        
        if (!labels.includes(item.data_coleta)) {
            labels.push(item.data_coleta);
        }
    });
    
    // Cores para cada componente
    const cores = {
        'Metano': '#1e40af',
        'Etano': '#10b981', 
        'Propano': '#f59e0b',
        'Nitrog√™nio': '#dc2626',
        'CO2': '#7c3aed'
    };
    
    // Criar datasets
    const datasets = Object.keys(componentesData).map(componente => {
        return {
            label: componente,
            data: componentesData[componente].map(item => item.y),
            borderColor: cores[componente] || '#666',
            backgroundColor: cores[componente] + '20' || '#66620',
            tension: 0.4,
            pointBackgroundColor: componentesData[componente].map(item => 
                item.status === 'VALIDADO' ? '#10b981' : '#dc2626'
            ),
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5
        };
    });
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.slice(-10), // √öltimas 10 datas
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Tend√™ncias CEP - Componentes Principais',
                    font: { size: 16, weight: 'bold' }
                },
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        labelColor: function(context) {
                            return {
                                borderColor: context.dataset.borderColor,
                                backgroundColor: context.dataset.borderColor
                            };
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Percentual Molar (%)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Data de Coleta'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
});

// Fun√ß√£o para limpar filtros
function clearFilters() {
    document.getElementById('periodo').value = '';
    document.getElementById('status_filter').value = '';
    document.getElementById('componente_filter').value = '';
    document.getElementById('filterForm').submit();
}

// Preservar valores dos filtros selecionados
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    
    ['periodo', 'status_filter', 'componente_filter'].forEach(param => {
        const value = urlParams.get(param);
        if (value) {
            const element = document.getElementById(param);
            if (element) element.value = value;
        }
    });
});
</script>

<style>
/* Aplicar fonte Inter em todo o dashboard */
.excel-container,
.excel-container * {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
}

/* Ajustar o header de filtros para ter a mesma largura visual dos demais */
.filters-container .section-header {
    margin: -20px -20px 15px -20px !important;
    border-radius: 8px 8px 0 0 !important;
}

/* Aplicar cantos arredondados aos resultado-item */
.resultado-item {
    border-radius: 0 !important;
}

.resultado-item:first-child {
    border-radius: 8px 0 0 8px !important;
}

.resultado-item:last-child {
    border-radius: 0 8px 8px 0 !important;
}

/* Se houver apenas um item, aplicar border-radius completo */
.resultado-item:only-child {
    border-radius: 8px !important;
}

/* Aplicar cantos arredondados ao container resultado-final */
.resultado-final {
    border-radius: 8px !important;
    overflow: hidden;
}

/* Fonte espec√≠fica para tabelas */
.componentes-excel,
.componentes-excel th,
.componentes-excel td {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
}

/* Fonte para cabe√ßalhos */
.brava-header,
.brava-header h1,
.brava-header .subtitle,
.section-header {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
}

/* Fonte para estat√≠sticas */
.stats-container h3,
.stats-container p {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
}

/* Fonte para filtros */
.filters-container,
.filters-container label,
.filters-container select,
.filters-container option {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
}

/* Fonte para bot√µes */
.btn {
    padding: 12px 24px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    display: inline-block;
    transition: all 0.2s;
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
}

.btn-primary {
    background: linear-gradient(135deg, #1e40af, #3b82f6);
    color: white;
}

.btn-secondary {
    background: linear-gradient(135deg, #6b7280, #9ca3af);
    color: white;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Melhorar legibilidade das tabelas com fonte Inter */
.componentes-excel .numeric {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
    font-variant-numeric: tabular-nums;
    font-weight: 500;
}

/* Ajustar peso das fontes para melhor legibilidade */
.componentes-excel th {
    font-weight: 600 !important;
    letter-spacing: 0.025em;
}

.componentes-excel td {
    font-weight: 400 !important;
    letter-spacing: 0.01em;
}

/* Fonte para nomes de componentes */
.componentes-excel .component-name {
    font-weight: 500 !important;
    letter-spacing: 0.01em;
}
</style>
{% endblock %}