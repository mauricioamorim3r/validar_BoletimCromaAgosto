{% extends "base.html" %}

{% block content %}
<div class="excel-container">
    <!-- Cabe√ßalho SGM - Dashboard -->
    <div class="brava-header">
        <div class="brava-logo">SGM</div>
        <h1>DASHBOARD - AN√ÅLISES CROMATOGR√ÅFICAS</h1>
        <div class="subtitle">Central de Informa√ß√µes das An√°lises dos Boletins de Cromatografia</div>
    </div>

    <!-- Filtros Avan√ßados - Mobile Optimized -->
    <div class="filters-container mobile-filters" style="background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 12px; padding: 1rem; margin: 1rem 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <div class="section-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <span>üîç FILTROS AVAN√áADOS</span>
            <button type="button" class="btn btn-sm btn-outline-primary d-md-none" id="toggleFilters" style="min-height: 36px;">
                <i class="bi bi-funnel"></i> <span id="filterToggleText">Mostrar</span>
            </button>
        </div>
        <form method="GET" id="filterForm" class="filter-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; align-items: end;">
            <div class="filter-field">
                <label for="periodo" style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 0.9rem;">üìÖ Per√≠odo:</label>
                <select name="periodo" id="periodo" class="form-control form-select" style="border-radius: 8px; border: 2px solid #e5e7eb; min-height: 44px;">
                    <option value="">üóìÔ∏è Todos os per√≠odos</option>
                    <option value="7">üìç √öltimos 7 dias</option>
                    <option value="30">üìä √öltimos 30 dias</option>
                    <option value="90">üìà √öltimos 90 dias</option>
                    <option value="365">üìÜ √öltimo ano</option>
                </select>
            </div>
            <div class="filter-field">
                <label for="status_filter" style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 0.9rem;">‚úÖ Status:</label>
                <select name="status_filter" id="status_filter" class="form-control form-select" style="border-radius: 8px; border: 2px solid #e5e7eb; min-height: 44px;">
                    <option value="">üîÑ Todos os status</option>
                    <option value="VALIDADO">‚úÖ Validados</option>
                    <option value="INVALIDADO">Invalidados</option>
                    <option value="PENDENTE">Pendentes</option>
                </select>
            </div>
            <div class="filter-field">
                <label for="componente_filter" style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 0.9rem;">üß™ Componente:</label>
                <select name="componente_filter" id="componente_filter" class="form-control form-select" style="border-radius: 8px; border: 2px solid #e5e7eb; min-height: 44px;">
                    <option value="">‚öóÔ∏è Todos os componentes</option>
                    <option value="Metano">CH‚ÇÑ Metano</option>
                    <option value="Etano">C‚ÇÇH‚ÇÜ Etano</option>
                    <option value="Propano">C‚ÇÉH‚Çà Propano</option>
                    <option value="i-Butano">i-C‚ÇÑH‚ÇÅ‚ÇÄ i-Butano</option>
                    <option value="n-Butano">n-C‚ÇÑH‚ÇÅ‚ÇÄ n-Butano</option>
                    <option value="i-Pentano">i-C‚ÇÖH‚ÇÅ‚ÇÇ i-Pentano</option>
                    <option value="n-Pentano">n-C‚ÇÖH‚ÇÅ‚ÇÇ n-Pentano</option>
                    <option value="Hexano">C‚ÇÜH‚ÇÅ‚ÇÑ Hexano</option>
                    <option value="Heptano">C‚ÇáH‚ÇÅ‚ÇÜ Heptano</option>
                    <option value="Octano">C‚ÇàH‚ÇÅ‚Çà Octano</option>
                    <option value="Nonano">C‚ÇâH‚ÇÇ‚ÇÄ Nonano</option>
                    <option value="Decano">C‚ÇÅ‚ÇÄH‚ÇÇ‚ÇÇ Decano</option>
                    <option value="Oxig√™nio">O‚ÇÇ Oxig√™nio</option>
                    <option value="Nitrog√™nio">N‚ÇÇ Nitrog√™nio</option>
                    <option value="CO2">CO‚ÇÇ Di√≥xido de Carbono</option>
                </select>
            </div>
            <div class="filter-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button type="submit" class="btn btn-primary" style="min-height: 44px; flex: 1; min-width: 120px; display: flex; align-items: center; justify-content: center; gap: 0.5rem; border-radius: 8px; font-weight: 600;">
                    <i class="bi bi-search"></i> Filtrar
                </button>
                <button type="button" class="btn btn-outline-secondary" style="min-height: 44px; flex: 1; min-width: 120px; display: flex; align-items: center; justify-content: center; gap: 0.5rem; border-radius: 8px; font-weight: 600;" onclick="clearFilters()">
                    <i class="bi bi-arrow-clockwise"></i> Limpar
                </button>
            </div>
        </form>
    </div>

    <!-- Cards de Estat√≠sticas -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0;">
        <!-- Card Total Boletins -->
        <div style="background: linear-gradient(135deg, #204bd6de, #204bd6de); color: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 10px 0; font-size: 2.5rem;">{{ stats.total | number_format(0) }}</h3>
            <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Total de Boletins</p>
        </div>

        <!-- Card Taxa Valida√ß√£o -->
        <div style="background: linear-gradient(135deg, #10b981, #34d399); color: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 10px 0; font-size: 2.5rem;">{{ stats.aprovados | number_format(0) }}</h3>
            <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Aprovados</p>
        </div>

        <!-- Card Pendentes -->
        <div style="background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 10px 0; font-size: 2.5rem;">{{ stats.pendentes | number_format(0) }}</h3>
            <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Pendentes</p>
        </div>

        <!-- Card Rejeitados -->
        <div style="background: linear-gradient(135deg, #ef4444, #f87171); color: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 10px 0; font-size: 2.5rem;">{{ stats.rejeitados | number_format(0) }}</h3>
            <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Rejeitados</p>
        </div>
    </div>

    <!-- Se√ß√£o: Componentes com Mais Problemas -->
    <div class="section-header">COMPONENTES COM MAIOR TAXA DE ERRO CEP</div>
    <div style="background: white; margin-bottom: 20px;font-size: 0.8rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <table class="componentes-excel">
            <thead>
                <tr>
                    <th>Componente</th>
                    <th>Total An√°lises</th>
                    <th>Invalidados CEP</th>
                    <th>Taxa de Erro</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for comp in componentes_problemas %}
                <tr>
                    <td class="component-name">{{ comp.nome }}</td>
                    <td class="numeric">{{ comp.total | number_format(0) }}</td>
                    <td class="numeric">{{ comp.invalidados | number_format(0) }}</td>
                    <td class="numeric">{{ comp.taxa_erro | number_format(2) }}%</td>
                    <td class="text-center">
                        <span class="status-{% if comp.taxa_erro < 20 %}validado{% else %}invalidado{% endif %}">
                            {% if comp.taxa_erro < 20 %}CONTROLADO{% else %}ATEN√á√ÉO{% endif %}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Se√ß√£o: √öltimos Boletins -->
    <div class="section-header">√öLTIMOS BOLETINS PROCESSADOS</div>
    <div style="background: white; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <table class="componentes-excel">
            <thead>
                <tr>
                    <th>Boletim</th>
                    <th>Instala√ß√£o</th>
                    <th>Data Coleta</th>
                    <th>Status Geral</th>
                    <th>A.G.A #8</th>
                    <th>CEP</th>
                    <th>Checklist</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for boletim in boletins_recentes %}
                <tr>
                    <td class="component-name">{{ boletim.numero_boletim }}</td>
                    <td>{{ boletim.identificacao_instalacao }}</td>
                    <td class="numeric">{{ boletim.data_coleta | date_format }}</td>
                    <td class="text-center">
                        <span class="status-{{ 'validado' if boletim.status == 'VALIDADO' else 'invalidado' }}">
                            {{ boletim.status or 'PENDENTE' }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="status-{{ 'validado' if boletim.status_aga8 == 'VALIDADO' else 'invalidado' }}">
                            {{ boletim.status_aga8 or '-' }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="status-{{ 'validado' if boletim.status_cep == 'VALIDADO' else 'invalidado' }}">
                            {{ boletim.status_cep or '-' }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="status-{{ 'validado' if boletim.status_checklist == 'VALIDADO' else 'invalidado' }}">
                            {{ boletim.status_checklist or '-' }}
                        </span>
                    </td>
                    <td class="text-center">
                        <a href="{{ url_for('relatorio', boletim_id=boletim.id) }}" 
                           style="background: #0a2472; color: white; padding: 5px 10px; text-decoration: none; border-radius: 4px; font-size: 0.85rem; font-weight: 600; margin-right: 4px;">
                            Ver Relat√≥rio
                        </a>
                        <a href="{{ url_for('relatorio_pdf', boletim_id=boletim.id) }}" 
                           style="background: #065535; color: white; padding: 5px 10px; text-decoration: none; border-radius: 4px; font-size: 0.85rem; font-weight: 600;"
                           target="_blank">
                            PDF
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Se√ß√£o: Gr√°fico de Tend√™ncias CEP -->
    <div class="section-header">GR√ÅFICO DE TEND√äNCIAS - COMPONENTES PRINCIPAIS</div>
    <div style="background: white; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <canvas id="cepTrendsChart" width="800" height="300" style="max-width: 100%;"></canvas>
        <p style="text-align: center; color: #666; font-size: 0.85rem; margin-top: 10px;">
            * Gr√°fico mostra as √∫ltimas an√°lises dos 5 componentes principais
        </p>
    </div>

    <!-- Resumo de Performance -->
    <div class="resultado-header">RESUMO DE PERFORMANCE DO SISTEMA</div>
    <div class="resultado-final">
        <div class="resultado-item" style="background: linear-gradient(135deg, #10b981, #34d399);">
            A.G.A #8<br>{{ stats.aprovados }}/{{ stats.total }}
        </div>
        <div class="resultado-item" style="background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white;">
            CEP<br>{{ stats.aprovados }}/{{ stats.total }}
        </div>
        <div class="resultado-item" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">
            CHECKLIST<br>{{ stats.aprovados }}/{{ stats.total }}
        </div>
    </div>
</div>

<!-- Script para Gr√°fico de Tend√™ncias -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('cepTrendsChart').getContext('2d');
    
    // Dados do hist√≥rico passados do template
    const historicoData = {{ historico_grafico | tojson }};
    
    // Processar dados por componente
    const componentesData = {};
    const labels = [];
    
    historicoData.forEach(item => {
        if (!componentesData[item.componente]) {
            componentesData[item.componente] = [];
        }
        componentesData[item.componente].push({
            x: item.data_coleta,
            y: item.valor,
            status: item.status_cep
        });
        
        if (!labels.includes(item.data_coleta)) {
            labels.push(item.data_coleta);
        }
    });
    
    // Cores para cada componente
    const cores = {
        'Metano': '#1e40af',
        'Etano': '#10b981', 
        'Propano': '#f59e0b',
        'Nitrog√™nio': '#dc2626',
        'CO2': '#7c3aed'
    };
    
    // Criar datasets
    const datasets = Object.keys(componentesData).map(componente => {
        return {
            label: componente,
            data: componentesData[componente].map(item => item.y),
            borderColor: cores[componente] || '#666',
            backgroundColor: cores[componente] + '20' || '#66620',
            tension: 0.4,
            pointBackgroundColor: componentesData[componente].map(item => 
                item.status === 'VALIDADO' ? '#10b981' : '#dc2626'
            ),
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5
        };
    });
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.slice(-10), // √öltimas 10 datas
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Tend√™ncias CEP - Componentes Principais',
                    font: { size: 16, weight: 'bold' }
                },
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        labelColor: function(context) {
                            return {
                                borderColor: context.dataset.borderColor,
                                backgroundColor: context.dataset.borderColor
                            };
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Percentual Molar (%)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Data de Coleta'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
});

// Fun√ß√£o para limpar filtros
function clearFilters() {
    document.getElementById('periodo').value = '';
    document.getElementById('status_filter').value = '';
    document.getElementById('componente_filter').value = '';
    document.getElementById('filterForm').submit();
}

// Preservar valores dos filtros selecionados
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    
    ['periodo', 'status_filter', 'componente_filter'].forEach(param => {
        const value = urlParams.get(param);
        if (value) {
            const element = document.getElementById(param);
            if (element) element.value = value;
        }
    });
});
</script>

<style>
/* Aplicar fonte Inter em todo o dashboard */
.excel-container,
.excel-container * {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
}

/* Ajustar o header de filtros para ter a mesma largura visual dos demais */
.filters-container .section-header {
    margin: -20px -20px 15px -20px !important;
    border-radius: 8px 8px 0 0 !important;
}

/* Aplicar cantos arredondados aos resultado-item */
.resultado-item {
    border-radius: 0 !important;
}

.resultado-item:first-child {
    border-radius: 8px 0 0 8px !important;
}

.resultado-item:last-child {
    border-radius: 0 8px 8px 0 !important;
}

/* Se houver apenas um item, aplicar border-radius completo */
.resultado-item:only-child {
    border-radius: 8px !important;
}

/* Aplicar cantos arredondados ao container resultado-final */
.resultado-final {
    border-radius: 8px !important;
    overflow: hidden;
}

/* Fonte espec√≠fica para tabelas */
.componentes-excel,
.componentes-excel th,
.componentes-excel td {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
}

/* Fonte para cabe√ßalhos */
.brava-header,
.brava-header h1,
.brava-header .subtitle,
.section-header {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
}

/* Fonte para estat√≠sticas */
.stats-container h3,
.stats-container p {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
}

/* Fonte para filtros */
.filters-container,
.filters-container label,
.filters-container select,
.filters-container option {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
}

/* Fonte para bot√µes */
.btn {
    padding: 12px 24px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    display: inline-block;
    transition: all 0.2s;
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
}

.btn-primary {
    background: linear-gradient(135deg, #1e40af, #3b82f6);
    color: white;
}

.btn-secondary {
    background: linear-gradient(135deg, #6b7280, #9ca3af);
    color: white;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Melhorar legibilidade das tabelas com fonte Inter */
.componentes-excel .numeric {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif !important;
    font-variant-numeric: tabular-nums;
    font-weight: 500;
}

/* Ajustar peso das fontes para melhor legibilidade */
.componentes-excel th {
    font-weight: 600 !important;
    letter-spacing: 0.025em;
}

.componentes-excel td {
    font-weight: 400 !important;
    letter-spacing: 0.01em;
}

/* Fonte para nomes de componentes */
.componentes-excel .component-name {
    font-weight: 500 !important;
    letter-spacing: 0.01em;
}

/* MOBILE DASHBOARD IMPROVEMENTS */
@media (max-width: 768px) {
    .mobile-filters .filter-form {
        display: none;
    }
    
    .mobile-filters .filter-form.show {
        display: grid;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .filter-field {
        margin-bottom: 1rem;
    }
    
    .filter-actions {
        grid-column: 1 / -1;
        margin-top: 0.5rem;
    }
    
    /* Melhorar cards de boletins */
    .boletim-card {
        border-radius: 12px !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important;
        margin-bottom: 1rem !important;
        overflow: hidden;
    }
    
    .boletim-card .card-header {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
        color: white !important;
        padding: 1rem !important;
        font-weight: 600 !important;
    }
    
    .boletim-card .card-body {
        padding: 1rem !important;
    }
    
    /* Bot√µes de a√ß√£o mobile */
    .boletim-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }
    
    .boletim-actions .btn {
        flex: 1;
        min-width: 120px;
        justify-content: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle de filtros mobile
    const toggleBtn = document.getElementById('toggleFilters');
    const filterForm = document.querySelector('.filter-form');
    const toggleText = document.getElementById('filterToggleText');
    
    if (toggleBtn && filterForm) {
        toggleBtn.addEventListener('click', function() {
            const isVisible = filterForm.classList.contains('show');
            
            if (isVisible) {
                filterForm.classList.remove('show');
                toggleText.textContent = 'Mostrar';
                toggleBtn.classList.remove('btn-primary');
                toggleBtn.classList.add('btn-outline-primary');
            } else {
                filterForm.classList.add('show');
                toggleText.textContent = 'Ocultar';
                toggleBtn.classList.remove('btn-outline-primary');
                toggleBtn.classList.add('btn-primary');
            }
        });
    }
    
    // Auto-submit em mudan√ßas de filtro para melhor UX mobile
    const filterSelects = document.querySelectorAll('#periodo, #status_filter, #componente_filter');
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            // Pequeno delay para feedback visual
            setTimeout(() => {
                if (window.showMobileToast) {
                    window.showMobileToast('üîÑ Aplicando filtros...', 'info');
                }
                document.getElementById('filterForm').submit();
            }, 200);
        });
    });
    
    // Melhorar experi√™ncia de loading
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.addEventListener('click', function() {
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Filtrando...';
            this.disabled = true;
        });
    }
});

// Fun√ß√£o para limpar filtros
function clearFilters() {
    document.getElementById('periodo').value = '';
    document.getElementById('status_filter').value = '';
    document.getElementById('componente_filter').value = '';
    
    if (window.showMobileToast) {
        window.showMobileToast('üîÑ Filtros limpos!', 'success');
    }
    
    setTimeout(() => {
        document.getElementById('filterForm').submit();
    }, 500);
}
</script>
{% endblock %}